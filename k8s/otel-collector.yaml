apiVersion: v1
kind: ConfigMap
metadata: { name: otel-collector-config, namespace: agent-stack }
data:
  otel-collector-config.yaml: |
    receivers: { otlp: { protocols: { http: {}, grpc: {} } } }
    exporters: { logging: { loglevel: info } }
    service:
      pipelines:
        traces: { receivers: [otlp], exporters: [logging] }
---
apiVersion: apps/v1
kind: Deployment
metadata: { name: otel-collector, namespace: agent-stack }
spec:
  replicas: 1
  selector: { matchLabels: { app: otel-collector } }
  template:
    metadata: { labels: { app: otel-collector } }
    spec:
      containers:
      - name: otel-collector
        image: otel/opentelemetry-collector:0.102.1
        args: ["--config=/etc/otelcol/otel-collector-config.yaml"]
        volumeMounts: [ { name: config, mountPath: /etc/otelcol } ]
        ports: [ { containerPort: 4318 } ]
      volumes:
      - name: config
        configMap:
          name: otel-collector-config
          items: [ { key: otel-collector-config.yaml, path: otel-collector-config.yaml } ]
---
apiVersion: v1
kind: Service
metadata: { name: otel-collector, namespace: agent-stack }
spec:
  selector: { app: otel-collector }
  ports: [ { port: 4318, targetPort: 4318 } ]
